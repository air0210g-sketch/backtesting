# 策略定义标准模板 (Strategy Input Requirement)

请按照下表填写策略逻辑，系统将根据此表自动生成或更新 `scripts/run_struct.py` 逻辑。

## 1. 基础信息
| 项目         | 内容                                                          | 备注 |
| :----------- | :------------------------------------------------------------ | :--- |
| **策略名称** | KDJ + Volume AGV Breakout                                     | 示例 |
| **策略描述** | 基于 KDJ 超卖金叉并配合成交量多重均线突破入场，高位死叉离场。 | 示例 |

## 2. 核心指标定义 (Indicators)
定义策略中用到的所有技术指标及其默认参数。

| 指标名称   | 变量名       | 默认参数 (n, m, ...) | 计算函数 (自 indicators.py)      |
| :--------- | :----------- | :------------------- | :------------------------------- |
| KDJ        | k, d, j      | n=9, m=3             | `inds.calc_kdj`                  |
| 成交量突破 | vol_breakout | multiple=1.25        | `inds.check_volume_agv_breakout` |

## 3. 交易逻辑 (Trading Logic)
使用上述指标定义具体的买入和卖出条件。

| 动作                 | 逻辑描述                                    | 代码逻辑表达 (示例)                                                                |
| :------------------- | :------------------------------------------ | :--------------------------------------------------------------------------------- |
| **买入点 (Entries)** | KDJ 金叉 (J < low_threshold) 且 成交量突破  | `inds.get_kdj_cross_signals(..., threshold=kdj_low, mode='long') & vol_breakout`   |
| **卖出点 (Exits)**   | KDJ 死叉 (J > high_threshold) 且 成交量突破 | `inds.get_kdj_cross_signals(..., threshold=kdj_high, mode='short') & vol_breakout` |

## 4. 风险控制 (Risk Management)
定义固定止损、止盈和追踪止损参数。

| 参数名       | 说明         | 默认值     | 备注     |
| :----------- | :----------- | :--------- | :------- |
| **sl_stop**  | 固定止损比例 | 0.15 (15%) | 必填     |
| **tp_stop**  | 固定止盈比例 | None       | 可选     |
| **sl_trail** | 追踪止损比例 | 0.20 (20%) | 建议开启 |

## 5. 参数寻优网格 (Optimization Grid)
定义哪些参数需要进行回测寻优，以及其范围。

| 参数变量              | 寻优范围 (Start, End, Step) | 最终生成列表                           |
| :-------------------- | :-------------------------- | :------------------------------------- |
| `kdj_low`             | 25 to 40 step 3             | `[25, 28, 31, 34, 37, 40]`             |
| `kdj_high`            | 75 to 90 step 3             | `[75, 78, 81, 84, 87, 90]`             |
| `multiple_volume_agv` | 1.25 to 1.50 step 0.05      | `[1.25, 1.30, 1.35, 1.40, 1.45, 1.50]` |
| `sl_stop`             | 0.15 to 0.30 step 0.05      | `[0.15, 0.20, 0.25, 0.30]`             |

---
**填表建议**：
1. 确保指标计算函数已在 `backtesting/indicators.py` 中实现。
2. 逻辑表达式尽量简洁，使用 `&` (与)、`|` (或)、`~` (非) 进行组合。
3. 寻优参数不宜过多，以免产生维度爆炸（组合数建议控制在 5000 以内）。

## 6. 性能优化（可选）
| 优化项 | 说明 |
| :----- | :--- |
| **指标预计算** | `runner.set_precompute_indicators("default")` 使用默认（周 KDJ）；或 `["kdj", "weekly_kdj", "atr"]` 从内置注册表启用。策略需声明对应参数（如 `k_df`, `d_df`, `j_df`, `atr_df`），有注入则用，否则内部计算。内置：`kdj`（日）、`weekly_kdj`（周）、`atr`（14 周期）。 |
| **数据缓存** | `load_data(use_cache=True)` 将对齐后的 OHLCV 存为 `data_dir/.cache/*.parquet`，下次启动若 CSV 未变则直接读缓存。 |
| **止损广播** | 框架已按列向 VectorBT 传入 `sl_stop`/`tp_stop`/`sl_trail` 数组，无需额外配置。 |
